import anime from"../anime.min.js";import{changeOpacity,opacityAnimationTime}from"./animation.min.js";import{headerElement}from"./header.min.js";import{addHoverEvent}from"./hoverEvents.min.js";import{InputElement}from"./inputElement.min.js";import{addTemporaryParam,pageUrl}from"./main.min.js";import{siteSettings}from"./settings.min.js";const maxSingleColumnOptions=7;class Dropdown extends InputElement{value;options;persistState;onInput;buttonElement;optionContainerElement;optionElements;isOpen=!1;selectedItem=0;scale=1;boundClose;constructor({element,name,persistState=!0,options,onInput=()=>{}}){super({element:element,name:name}),this.options=Object.assign({"":this.name},options),this.onInput=onInput,this.value="",this.persistState=persistState,this.buttonElement=this.element.previousElementSibling,this.boundClose=this.close.bind(this);var t=Object.keys(this.options).length;this.buttonElement.textContent=this.name,this.selectOptionElements=[];for(const n in this.options){var e=document.createElement("option");e.value=n,e.textContent=this.options[n],this.element.appendChild(e),this.selectOptionElements.push(e)}this.buttonElement.innerHTML="",this.buttonElement.parentNode.parentNode.style.gridTemplateColumns="repeat(auto-fit, 100%)",this.optionContainerElement=document.createElement("div"),this.optionContainerElement.classList.add("option-container"),t>maxSingleColumnOptions&&this.optionContainerElement.classList.add("two-column"),this.buttonElement.appendChild(this.optionContainerElement),this.optionElements=[],this.selectOptionElements.forEach((option,index)=>{var t=document.createElement("div");t.textContent=option.textContent,t.setAttribute("data-option-name",0===index?"default":option.getAttribute("value")),t.setAttribute("data-option-index",index),this.optionElements.push(t),this.optionContainerElement.appendChild(t)}),setTimeout(()=>{if(this.optionElements.slice(1).forEach(element=>{addHoverEvent({element:element})}),this.optionElements[0].innerHTML+=' <span style="font-size: 12px; margin-right: -2px">&#x25BC;</span>',this.buttonElement.style.height=1.075*this.optionElements[this.selectedItem].getBoundingClientRect().height+"px",this.buttonElement.style.width=this.optionElements[this.selectedItem].getBoundingClientRect().width+16+"px",this.buttonElement.parentNode.parentNode.style.height=1.075*this.optionElements[this.selectedItem].getBoundingClientRect().height+"px",this.buttonElement.parentNode.parentNode.style.width=this.optionElements[this.selectedItem].getBoundingClientRect().width+16+"px",this.optionContainerElement.style.transform="translateY(-10px)",this.buttonElement.addEventListener("click",()=>{this.isOpen||this.open()}),this.persistState){const t=new URLSearchParams(window.location.search).get(this.element.id);t&&setTimeout(()=>{this.setValue({newValue:decodeURIComponent(t),instant:!0})},10),addTemporaryParam(this.element.id)}},16)}async open(animationTime=opacityAnimationTime){this.isOpen=!0,siteSettings.reduceMotion&&(await changeOpacity({element:this.buttonElement,opacity:0,duration:75}),this.buttonElement.classList.remove("hover-reduce-motion"),animationTime=10),this.buttonElement.classList.add("expanded"),this.buttonElement.classList.add("no-hover");var t=getComputedStyle(this.buttonElement).transform;const e="none"===t?1:parseFloat(t.slice(t.indexOf("(")+1,t.indexOf(",")));let n=0,i=0,o=0;this.optionElements.forEach((element,index)=>{0===index?n=element.getBoundingClientRect().width/e:index%2==0?i=Math.max(i,element.getBoundingClientRect().width/e):o=Math.max(o,element.getBoundingClientRect().width/e)});var t=Math.max(this.optionContainerElement.classList.contains("two-column")?i+o:Math.max(i,o),n),s=this.optionContainerElement.getBoundingClientRect().height/e+4,a=headerElement.getBoundingClientRect().height,l=window.innerHeight-a-20,t=t+24,m=window.innerWidth-20,m=(this.scale=Math.min(m/t,Math.min(l/s,1)),s*this.scale),l=t*this.scale,h=this.buttonElement.getBoundingClientRect(),d=h.top+h.height/e/2-m/2,m=h.bottom-h.height/e/2+m/2,r=h.left+h.width/e/2-l/2,h=h.right-h.width/e/2+l/2,l=parseFloat(window.getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-top").slice(0,-2)),p=parseFloat(window.getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-bottom").slice(0,-2)),c=parseFloat(window.getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-left").slice(0,-2)),u=parseFloat(window.getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-right").slice(0,-2));let g=0,E=(m>window.innerHeight-10-p?g=window.innerHeight-10-p-m:d<10+a+l&&(g=10+a+l-d),0);h>window.innerWidth-10-u?E=window.innerWidth-10-u-h:r<10+c&&(E=10+c-r),await Promise.all([anime({targets:this.buttonElement,height:s,width:t,translateY:g,translateX:E,scale:this.scale,easing:"easeOutQuad",duration:animationTime}).finished,anime({targets:this.optionContainerElement,translateY:0,translateX:0,easing:"easeOutQuad",duration:animationTime}).finished]),document.documentElement.addEventListener("click",this.boundClose),siteSettings.reduceMotion&&await changeOpacity({element:this.buttonElement,opacity:1,duration:100})}async close(e){let t=document.elementFromPoint(e.clientX,e.clientY);for(;!t.hasAttribute("data-option-index")&&"HTML"!==t.tagName;)t=t.parentNode;await this.setValue({newValue:t.getAttribute("data-option-name"),fromOnClickHandler:!0})}async setValue({newValue,instant=!1,fromOnClickHandler=!1}){var t=!this.isOpen,e=(t&&(instant?this.buttonElement.style.opacity=0:await changeOpacity({element:this.buttonElement,opacity:0,duration:opacityAnimationTime/2.5}),await this.open(10)),document.documentElement.removeEventListener("click",this.boundClose),this.isOpen=!1,this.selectedItem);if(newValue&&(n=this.optionContainerElement.querySelector(`[data-option-name=${newValue}]`),this.selectedItem=parseInt(n.getAttribute("data-option-index")??this.selectedItem),0===this.selectedItem)&&fromOnClickHandler&&(this.selectedItem=e),this.element.value=this.selectOptionElements[this.selectedItem].value,this.value=this.element.value,e!==this.selectedItem&&this.selectedItem)try{this.onInput(fromOnClickHandler)}catch(t){}var n=this.optionContainerElement.children[0].getBoundingClientRect(),e=this.optionContainerElement.children[this.selectedItem].getBoundingClientRect(),i=(n.top-e.top)/this.scale-10,n=-(-n.width/2+e.left-n.left+e.width/2)/this.scale;this.persistState&&(e=new URLSearchParams(window.location.search),0!==this.selectedItem?e.set(this.element.id,encodeURIComponent(this.optionElements[this.selectedItem].getAttribute("data-option-name"))):e.delete(this.element.id),e=e.toString(),window.history.replaceState({url:pageUrl},"",pageUrl.replace(/\/home\//,"/")+(e?"?"+e:""))),siteSettings.reduceMotion&&(await changeOpacity({element:this.buttonElement,opacity:0,duration:150}),this.buttonElement.classList.remove("hover-reduce-motion"),instant=!0),this.buttonElement.classList.remove("expanded"),await Promise.all([anime({targets:[this.buttonElement,this.buttonElement.parentNode.parentNode],height:this.optionElements[this.selectedItem].getBoundingClientRect().height/this.scale+4,width:this.optionElements[this.selectedItem].getBoundingClientRect().width/this.scale+16,translateY:0,translateX:0,scale:1,easing:"easeOutQuad",duration:instant?1:opacityAnimationTime}).finished,anime({targets:this.optionContainerElement,translateY:i,translateX:n,easing:"easeOutQuad",duration:instant?1:opacityAnimationTime}).finished]),siteSettings.reduceMotion&&await changeOpacity({element:this.buttonElement,opacity:1,duration:100}),t&&(instant?this.buttonElement.style.opacity=1:await changeOpacity({element:this.buttonElement,opacity:1,duration:opacityAnimationTime/3})),this.buttonElement.classList.remove("no-hover")}}export{Dropdown};