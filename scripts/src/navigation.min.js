import{clearCurrentlyLoadedApplets,currentlyLoadedApplets}from"../applets/applet.min.js";import{fadeDownOut,fadeLeftOut,fadeOut,fadeRightOut,fadeUpOut,opacityAnimationTime}from"./animation.min.js";import{bannerElement,bannerPages,loadBanner,preloadBanner}from"./banners.min.js";import{cardIsOpen,hideCard}from"./cards.min.js";import{clearDesmosGraphs,desmosGraphs}from"./desmos.min.js";import{loadPage}from"./loadPage.min.js";import{asyncFetch,clearTemporaryIntervals,clearTemporaryListeners,clearTemporaryParams,clearTemporaryWorkers,pageElement,pageUrl,setPageUrl,temporaryIntervals,temporaryListeners,temporaryParams,temporaryWorkers}from"./main.min.js";import{forceThemePages,getQueryParams,revertTheme,setForcedTheme,setRevertThemeTo,siteSettings,toggleDarkTheme}from"./settings.min.js";import{sitemap}from"./sitemap.min.js";let currentlyRedirecting=!1;function setCurrentlyRedirecting(newCurrentlyRedirecting){currentlyRedirecting=newCurrentlyRedirecting}let lastPageScroll=0,navigationTransitionType=0;const urlsFetched=[];async function redirect({url,inNewTab=!1,noStatePush=!1,restoreScroll=!1,noFadeOut=!1}){var e,r,t;currentlyRedirecting||url===pageUrl||(inNewTab||-1!==url.indexOf("http")||-1!==url.indexOf("mailto:")||".pdf"==url.slice(-4)?window.open(url,"_blank"):(e=-1!==url.indexOf("?")?([e,r]=url.split("?"),url=e,r):"",currentlyRedirecting=!0,r=window.scrollY,[t]=(navigationTransitionType=getTransitionType(url),await Promise.all([asyncFetch(url+"data.html"),preloadBanner(url),fadeOutPage(noFadeOut),cardIsOpen?hideCard():Promise.resolve()])),loadBanner({url:url}),forceThemePages[url]?(setForcedTheme(!0),siteSettings.darkTheme!==forceThemePages[url]&&(setRevertThemeTo(siteSettings.darkTheme),await toggleDarkTheme({force:!0}))):forceThemePages[url]||await revertTheme(),unloadPage(),document.body.firstElementChild.insertAdjacentHTML("beforebegin",`<div class="page"${opacityAnimationTime?'style="opacity: 0"':""}>${t}</div>`),setPageUrl(url),urlsFetched.push(url),loadPage(),noStatePush?history.replaceState({url:url},document.title,getDisplayUrl(e)):history.pushState({url:url},document.title,getDisplayUrl(e)),document.documentElement.style.overflowY="scroll",document.body.style.overflowY="visible",document.body.style.userSelect="auto",document.body.style.WebkitUserSelect="auto",restoreScroll?window.scrollTo(0,lastPageScroll):window.scrollTo(0,0),lastPageScroll=r))}function getTransitionType(url){if(!(url in sitemap)||url===pageUrl||!pageUrl||siteSettings.reduceMotion)return 0;let e=pageUrl;for(;""!==e;)if(url===(e=sitemap[e].parent))return-1;for(e=url;""!==e;)if(e=sitemap[e].parent,pageUrl===e)return 1;if(sitemap[url].parent!==sitemap[pageUrl].parent)return 0;{const e=sitemap[url].parent;return sitemap[e].children.indexOf(url)>sitemap[e].children.indexOf(pageUrl)?2:-2}}function getDisplayUrl(additionalQueryParams){var e=getQueryParams()+(additionalQueryParams?"&"+additionalQueryParams:"");let r=pageUrl.replace(/\/home\//,"/")+(e?"?"+e:"");return r=1<r.length&&"/"===r[r.length-1]?r.slice(0,r.length-1):r}async function fadeOutPage(noFadeOut){opacityAnimationTime&&(noFadeOut?pageElement.style.opacity=0:(await(1===navigationTransitionType?bannerElement?Promise.all([fadeUpOut({element:bannerElement,noOpacityChange:!0}),fadeUpOut({element:pageElement})]):fadeUpOut({element:pageElement}):-1===navigationTransitionType?bannerElement?Promise.all([fadeDownOut({element:bannerElement,noOpacityChange:!0}),fadeDownOut({element:pageElement})]):fadeDownOut({element:pageElement}):2===navigationTransitionType?bannerElement?Promise.all([fadeLeftOut({element:bannerElement,noOpacityChange:!0}),fadeLeftOut({element:pageElement})]):fadeLeftOut({element:pageElement}):-2===navigationTransitionType?bannerElement?Promise.all([fadeRightOut({element:bannerElement,noOpacityChange:!0}),fadeRightOut({element:pageElement})]):fadeRightOut({element:pageElement}):bannerElement?Promise.all([fadeOut({element:bannerElement,noOpacityChange:!0}),fadeOut({element:pageElement})]):fadeOut({element:pageElement})),await new Promise(resolve=>setTimeout(resolve,33))))}function unloadPage(){document.querySelectorAll("script, .temporary-style, .WILSON_fullscreen-container, .temporary-element").forEach(element=>element.remove()),temporaryListeners.forEach(temporaryListener=>{temporaryListener[0].removeEventListener(temporaryListener[1],temporaryListener[2])}),clearTemporaryListeners(),temporaryIntervals.forEach(refreshId=>clearInterval(refreshId)),clearTemporaryIntervals();for(const key in temporaryWorkers)temporaryWorkers[key]?.terminate&&temporaryWorkers[key].terminate();clearTemporaryWorkers();for(const key in desmosGraphs)desmosGraphs[key].destroy();clearDesmosGraphs();const e=new URLSearchParams(window.location.search);temporaryParams.forEach(key=>{e.delete(key)});var r=e.toString();window.history.replaceState({url:pageUrl},"",pageUrl.replace(/\/home\//,"/")+(r?"?"+r:"")),clearTemporaryParams(),document.documentElement.style.overscrollBehaviorY="auto",currentlyLoadedApplets.forEach(applet=>{applet?.destroy&&applet.destroy()}),clearCurrentlyLoadedApplets(),pageElement.remove()}async function prefetchPage(url){var e,r;url=url.replace(/^https*:\/\/.+?(\/.+)$/,(match,$1)=>$1),urlsFetched.includes(url)||(urlsFetched.push(url),e=[url+"data.html"],bannerPages.includes(url)&&e.push(url+"banners/small.webp"),(r=sitemap[url])?.customScript&&e.push(url+"scripts/index.min.js"),r?.customStyle&&e.push(url+"style/index.min.css"),await Promise.all(e.map(urlToFetch=>asyncFetch(urlToFetch))))}export{currentlyRedirecting,setCurrentlyRedirecting,navigationTransitionType,redirect,getDisplayUrl,prefetchPage};