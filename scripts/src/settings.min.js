import{currentlyLoadedApplets}from"../applets/applet.min.js";import{cardIsOpen}from"./cards.min.js";import{recreateDesmosGraphs}from"./desmos.min.js";import{darkThemeCheckbox,increaseContrastCheckbox,reduceMotionCheckbox}from"./header.min.js";import{addStyle,pageUrl}from"./main.min.js";import{getDisplayUrl}from"./navigation.min.js";import anime from"/scripts/anime.min.js";const forceThemePages={"/gallery/":!0,"/slides/oral-exam/":!0},rootElement=document.querySelector(":root"),metaThemeColorElement=document.querySelector("#theme-color-meta");let themeToggles=0;const params=new URLSearchParams(window.location.search),darkTheme=null===params.get("theme")?matchMedia("(prefers-color-scheme: dark)").matches:"1"===params.get("theme"),reduceMotion=null===params.get("reducemotion")?matchMedia("(prefers-reduced-motion: reduce)").matches:"1"===params.get("reducemotion"),increaseContrast=null===params.get("increasecontrast")?matchMedia("(prefers-contrast: more)").matches:"1"===params.get("increasecontrast"),siteSettings={darkTheme:darkTheme,reduceMotion:reduceMotion,increaseContrast:increaseContrast,card:params.get("card"),resolutionMultiplier:parseFloat(params.get("resmult")??"1")};let revertThemeTo=null;function setRevertThemeTo(newRevertThemeTo){revertThemeTo=newRevertThemeTo}let forcedTheme=!1;function setForcedTheme(newForcedTheme){forcedTheme=newForcedTheme,darkThemeCheckbox&&darkThemeCheckbox.setDisabled(!0)}function getQueryParams(){var e=new URLSearchParams(window.location.search);return e.delete("page"),forcedTheme||(siteSettings.darkTheme&&!matchMedia("(prefers-color-scheme: dark)").matches?e.set("theme","1"):!siteSettings.darkTheme&&matchMedia("(prefers-color-scheme: dark)").matches?e.set("theme","0"):e.delete("theme")),siteSettings.reduceMotion&&!matchMedia("(prefers-reduced-motion: reduce)").matches?e.set("reducemotion","1"):!siteSettings.reduceMotion&&matchMedia("(prefers-reduced-motion: reduce)").matches?e.set("reducemotion","0"):e.delete("reducemotion"),siteSettings.increaseContrast&&!matchMedia("(prefers-contrast: more)").matches?e.set("increasecontrast","1"):!siteSettings.increaseContrast&&matchMedia("(prefers-contrast: more)").matches?e.set("increasecontrast","0"):e.delete("increasecontrast"),siteSettings.card?e.set("card",siteSettings.card):e.delete("card"),siteSettings.resolutionMultiplier&&1!==siteSettings.resolutionMultiplier?e.set("resmult",siteSettings.resolutionMultiplier):e.delete("resmult"),window.OFFLINE?e.set("debug","2"):window.DEBUG?e.set("debug","1"):e.delete("debug"),e.toString()}function initReduceMotion(){matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",e=>{siteSettings.reduceMotion=e.matches,reduceMotionCheckbox&&reduceMotionCheckbox.setChecked({newChecked:siteSettings.reduceMotion})})}function initIncreaseContrast(){matchMedia("(prefers-contrast: more)").addEventListener("change",e=>{e.matches!==siteSettings.increaseContrast&&(toggleIncreaseContrast({}),increaseContrastCheckbox)&&increaseContrastCheckbox.setChecked({newChecked:siteSettings.increaseContrast})}),siteSettings.increaseContrast&&toggleIncreaseContrast({noAnimation:!(siteSettings.increaseContrast=!1)})}async function initDarkTheme(){matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{cardIsOpen||(e.matches&&!siteSettings.darkTheme||!e.matches&&siteSettings.darkTheme)&&toggleDarkTheme({})}),void 0!==forceThemePages[pageUrl]?forceThemePages[pageUrl]?(setForcedTheme(!0),setRevertThemeTo(siteSettings.darkTheme),siteSettings.darkTheme=!forceThemePages[pageUrl],await toggleDarkTheme({noAnimation:!0,force:!0})):forceThemePages[pageUrl]||revertTheme():siteSettings.darkTheme&&await toggleDarkTheme({noAnimation:!(siteSettings.darkTheme=!1)})}async function revertTheme(){forcedTheme=forcedTheme&&!1,darkThemeCheckbox&&darkThemeCheckbox.setDisabled(!1),null!==revertThemeTo&&(siteSettings.darkTheme!==revertThemeTo&&await toggleDarkTheme({force:!0}),revertThemeTo=null)}async function toggleDarkTheme({noAnimation=!1,force=!1,duration=500}){if((force||!(pageUrl in forceThemePages))&&!handleEasterEgg())if(updateCode(0),siteSettings.darkTheme=!siteSettings.darkTheme,darkThemeCheckbox&&darkThemeCheckbox.setChecked({newChecked:siteSettings.darkTheme}),recreateDesmosGraphs(),history.replaceState({url:pageUrl},document.title,getDisplayUrl()),noAnimation)metaThemeColorElement.setAttribute("content",siteSettings.darkTheme?"#181818":"#ffffff"),rootElement.style.setProperty("--theme",siteSettings.darkTheme?1:0);else{var e=addStyle(`
			*:not(.page, #banner, .desmos-container)
			{
				transition: none !important;
			}
		`);const t={t:siteSettings.darkTheme?0:1};await Promise.all([anime({targets:metaThemeColorElement,content:siteSettings.darkTheme?"#181818":"#ffffff",duration:duration,easing:"cubicBezier(.25, .1, .25, 1)"}).finished,anime({targets:t,t:siteSettings.darkTheme?1:0,duration:duration,easing:"cubicBezier(.25, .1, .25, 1)",update:()=>{rootElement.style.setProperty("--theme",t.t)},complete:()=>{rootElement.style.setProperty("--theme",siteSettings.darkTheme?1:0)}}).finished]),e.remove()}}async function toggleReduceMotion(){updateCode(1),siteSettings.reduceMotion=!siteSettings.reduceMotion,currentlyLoadedApplets.forEach(applet=>{for(const e of applet.wilsons)e.reduceMotion=siteSettings.reduceMotion}),history.replaceState({url:pageUrl},document.title,getDisplayUrl())}async function toggleIncreaseContrast({noAnimation=!1,duration=150}){if(updateCode(2),siteSettings.increaseContrast=!siteSettings.increaseContrast,history.replaceState({url:pageUrl},document.title,getDisplayUrl()),noAnimation)rootElement.style.setProperty("--contrast",siteSettings.increaseContrast?1:0);else{var e=addStyle(`
			*:not(.checkbox)
			{
				transition: none !important;
			}
		`);const t={t:siteSettings.increaseContrast?0:1};await anime({targets:t,t:siteSettings.increaseContrast?1:0,duration:duration,easing:"easeInOutSine",update:()=>{rootElement.style.setProperty("--contrast",t.t)},complete:()=>{rootElement.style.setProperty("--contrast",siteSettings.increaseContrast?1:0)}}).finished,e.remove()}}let settingsCode=[];const streetlightsCode=[0,1,2,1,0,1,2,1];function updateCode(digit){settingsCode.push(digit),settingsCode.length>=streetlightsCode.length&&(settingsCode=settingsCode.slice(-streetlightsCode.length)).join("")===streetlightsCode.join("")&&addStyle(`
				#logo img, #logo-no-link img
				{
					background: linear-gradient(180deg, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 14.2857142857%, rgba(185,185,185,1) 14.2857142857%, rgba(185,185,185,1) 28.5714285714%, rgba(255,255,255,1) 28.5714285714%, rgba(255,255,255,1) 42.8571428571%, rgba(184,244,131,1) 42.8571428571%, rgba(184,244,131,1) 57.1428571429%, rgba(255,255,255,1) 57.1428571429%, rgba(255,255,255,1) 71.4285714286%, rgba(185,185,185,1) 71.4285714286%, rgba(185,185,185,1) 85.7142857143%, rgba(0,0,0,1) 85.7142857143%, rgba(0,0,0,1) 100%);
				}
			`,!1)}let timeoutId,shownEasterEgg=!1;function handleEasterEgg(){if(themeToggles++,clearTimeout(timeoutId),timeoutId=setTimeout(()=>themeToggles=0,300),8<=themeToggles&&!shownEasterEgg){shownEasterEgg=!0,clearTimeout(timeoutId),document.body.querySelector("#header-settings-button").innerHTML="boo",addStyle(`
			#banner, img, canvas
			{
				filter: brightness(max(calc(var(--extra-brightness) / 10), 1)) saturate(var(--extra-brightness)) contrast(var(--extra-brightness)) hue-rotate(calc(var(--extra-brightness) * 5deg));
			}
		`,!1);const e={t:1},t=siteSettings.darkTheme?"lch(8.25% 0 0)":"lch(100% 0 0)",r=siteSettings.darkTheme?"lch(100% 23.2 0)":"lch(0% 0 0)",s=siteSettings.darkTheme?"lch(83.48% 0 0)":"lch(27.09% 0 0)",o=siteSettings.darkTheme?"lch(74.78% 0 0)":"lch(40.73% 0 0)";document.documentElement.style.filter="brightness(1)",anime({targets:e,t:0,duration:2e3,easing:"easeOutQuad",update:()=>{rootElement.style.setProperty("--background",`color-mix(in lch, ${t} ${100*e.t}%, lch(46.62% 108.32 40.84))`),rootElement.style.setProperty("--high-contrast",`color-mix(in lch, ${r} ${100*e.t}%, lch(79.24% 134.33 134.57))`),rootElement.style.setProperty("--normal-contrast",`color-mix(in lch, ${s} ${100*e.t}%, lch(79.24% 134.33 134.57))`),rootElement.style.setProperty("--low-contrast",`color-mix(in lch, ${o} ${100*e.t}%, lch(79.24% 134.33 134.57))`),rootElement.style.setProperty("--extra-brightness",10*(1-e.t)+1)}})}return shownEasterEgg}export{forceThemePages,metaThemeColorElement,siteSettings,setRevertThemeTo,setForcedTheme,getQueryParams,initReduceMotion,initIncreaseContrast,initDarkTheme,revertTheme,toggleDarkTheme,toggleReduceMotion,toggleIncreaseContrast};