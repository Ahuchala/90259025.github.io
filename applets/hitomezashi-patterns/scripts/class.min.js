import{Applet,hsvToRgb}from"../../../scripts/applets/applet.min.js";import{convertColor}from"/scripts/src/browser.min.js";import{WilsonCPU}from"/scripts/wilson.min.js";class HitomezashiPatterns extends Applet{doDrawBoundaries=!0;doDrawRegions=!0;maximumSpeed=!1;resolution;gridSize;rowProb;colProb;patternRows=[];patternCols=[];regions=[];regionsOrdered=[];regionSizes=[];numRegions=0;numUniqueRegionSizes=0;cellsByRadius=[];currentRow=1;currentCol=1;currentRegion=0;lineWidth;constructor({canvas}){super(canvas);var i={canvasWidth:1e3,fullscreenOptions:{onSwitch:this.switchFullscreen.bind(this),beforeSwitch:this.beforeSwitchFullscreen.bind(this),useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"}};this.wilson=new WilsonCPU(canvas,i)}run({resolution=2e3,gridSize=50,rowProb=.5,colProb=.5,doDrawBoundaries=!0,doDrawRegions=!0,maximumSpeed=!1}){this.resolution=resolution,this.gridSize=gridSize,this.rowProb=rowProb,this.colProb=colProb,this.doDrawBoundaries=doDrawBoundaries,this.doDrawRegions=doDrawRegions,this.maximumSpeed=maximumSpeed,this.wilson.resizeCanvas({width:this.resolution}),this.wilson.ctx.fillStyle=convertColor(0,0,0),this.wilson.ctx.fillRect(0,0,this.resolution,this.resolution),this.wilson.ctx.strokeStyle=convertColor(127,127,127),this.lineWidth=this.resolution/this.gridSize/20,this.wilson.ctx.lineWidth=this.lineWidth,this.patternRows=new Array(this.gridSize+1),this.patternCols=new Array(this.gridSize+1),this.regions=new Array(this.gridSize),this.regionsOrdered=[],this.regionSizes=[],this.numRegions=0,this.cellsByRadius=new Array(this.gridSize+1);for(let s=0;s<this.gridSize+1;s++){this.patternRows[s]=new Array(this.gridSize+1),this.patternCols[s]=new Array(this.gridSize+1);for(let i=0;i<this.gridSize+1;i++)this.patternRows[s][i]=0,this.patternCols[s][i]=0}for(let e=0;e<this.gridSize;e++){this.regions[e]=new Array(this.gridSize);for(let i=0;i<this.gridSize;i++)this.regions[e][i]=-1}for(let i=0;i<this.gridSize+1;i++)this.cellsByRadius[i]=[];var t=Math.floor(this.gridSize/2);for(let r=0;r<this.gridSize;r++)for(let i=0;i<this.gridSize;i++)this.cellsByRadius[Math.abs(r-t)+Math.abs(i-t)].push([r,i]);for(let o=0;o<this.gridSize+1;o++)for(let i=Math.random()<this.rowProb?1:0;i<this.gridSize;i+=2)this.patternRows[o][i]=1;for(let n=0;n<this.gridSize+1;n++)for(let i=Math.random()<this.colProb?1:0;i<this.gridSize;i+=2)this.patternCols[i][n]=1;this.maximumSpeed?(this.doDrawBoundaries&&this.drawBoundaries(),this.doDrawRegions&&(this.identifyRegions(),this.drawRegions())):this.doDrawBoundaries?(this.currentRow=1,this.currentCol=1,this.drawBoundaryRowStep()):this.doDrawRegions&&(this.identifyRegions(),this.currentRegion=0,this.drawRegionsStep())}drawBoundaries(){for(let t=1;t<this.gridSize;t++)for(let i=0;i<this.gridSize;i++)this.patternRows[t][i]&&(this.wilson.ctx.beginPath(),this.wilson.ctx.moveTo(this.resolution/this.gridSize*i,this.resolution/this.gridSize*t),this.wilson.ctx.lineTo(this.resolution/this.gridSize*(i+1),this.resolution/this.gridSize*t),this.wilson.ctx.stroke());for(let s=0;s<this.gridSize;s++)for(let i=1;i<this.gridSize;i++)this.patternCols[s][i]&&(this.wilson.ctx.beginPath(),this.wilson.ctx.moveTo(this.resolution/this.gridSize*i,this.resolution/this.gridSize*s),this.wilson.ctx.lineTo(this.resolution/this.gridSize*i,this.resolution/this.gridSize*(s+1)),this.wilson.ctx.stroke())}drawBoundaryRowStep(){for(let i=0;i<this.gridSize;i++)this.patternRows[this.currentRow][i]&&(this.wilson.ctx.beginPath(),this.wilson.ctx.moveTo(this.resolution/this.gridSize*i,this.resolution/this.gridSize*this.currentRow),this.wilson.ctx.lineTo(this.resolution/this.gridSize*(i+1),this.resolution/this.gridSize*this.currentRow),this.wilson.ctx.stroke());this.currentRow++,this.currentRow<this.gridSize?this.animationPaused||requestAnimationFrame(this.drawBoundaryRowStep.bind(this)):this.animationPaused||requestAnimationFrame(this.drawBoundaryColStep.bind(this))}drawBoundaryColStep(){for(let i=0;i<this.gridSize;i++)this.patternCols[i][this.currentCol]&&(this.wilson.ctx.beginPath(),this.wilson.ctx.moveTo(this.resolution/this.gridSize*this.currentCol,this.resolution/this.gridSize*i),this.wilson.ctx.lineTo(this.resolution/this.gridSize*this.currentCol,this.resolution/this.gridSize*(i+1)),this.wilson.ctx.stroke());this.currentCol++,this.currentCol<this.gridSize?this.animationPaused||requestAnimationFrame(this.drawBoundaryColStep.bind(this)):this.doDrawRegions&&(this.identifyRegions(),this.currentRegion=0,setTimeout(this.drawRegionsStep.bind(this),1e3))}identifyRegions(){let e=0,r=0;for(;;){var o=[[e,r]];for(this.regions[e][r]=this.numRegions,this.regionsOrdered.push([[e,r]]);0!==o.length;){var n=o.length;for(let i=0;i<n;i++){var h=o[i][0],l=o[i][1];0<h&&-1===this.regions[h-1][l]&&!this.patternRows[h][l]&&(o.push([h-1,l]),this.regions[h-1][l]=this.numRegions,this.regionsOrdered[this.numRegions].push([h-1,l])),h<this.gridSize-1&&-1===this.regions[h+1][l]&&!this.patternRows[h+1][l]&&(o.push([h+1,l]),this.regions[h+1][l]=this.numRegions,this.regionsOrdered[this.numRegions].push([h+1,l])),0<l&&-1===this.regions[h][l-1]&&!this.patternCols[h][l]&&(o.push([h,l-1]),this.regions[h][l-1]=this.numRegions,this.regionsOrdered[this.numRegions].push([h,l-1])),l<this.gridSize-1&&-1===this.regions[h][l+1]&&!this.patternCols[h][l+1]&&(o.push([h,l+1]),this.regions[h][l+1]=this.numRegions,this.regionsOrdered[this.numRegions].push([h,l+1]))}o.splice(0,n)}this.regionSizes.push(this.regionsOrdered[this.numRegions].length);let t=!1;for(let s=0;s<=this.gridSize;s++){for(let i=0;i<this.cellsByRadius[s].length;i++){var d=this.cellsByRadius[s][i][0],g=this.cellsByRadius[s][i][1];if(-1===this.regions[d][g]){e=d,r=g,t=!0;break}}if(t)break}if(this.numRegions++,!t)break}this.regionSizes=Array.from(new Set(this.regionSizes)),this.regionSizes.sort((a,b)=>b-a),this.numUniqueRegionSizes=this.regionSizes.length}drawRegions(){this.wilson.ctx.fillStyle=convertColor(0,0,0),this.wilson.ctx.fillRect(0,0,this.resolution,this.resolution);for(let n=0;n<this.numRegions;n++){var t=this.regionsOrdered[n].length,s=n%(2*this.gridSize)/(2*this.gridSize),e=1===t?.5:Math.sqrt(this.regionSizes.indexOf(t)/(this.numUniqueRegionSizes-2)),s=hsvToRgb(s,1,e);this.wilson.ctx.fillStyle=convertColor(...s);for(let i=0;i<t;i++){var r=this.regionsOrdered[n][i][0],o=this.regionsOrdered[n][i][1];this.wilson.ctx.fillRect(this.resolution/this.gridSize*o+this.lineWidth/2,this.resolution/this.gridSize*r+this.lineWidth/2,this.resolution/this.gridSize-this.lineWidth,this.resolution/this.gridSize-this.lineWidth)}}}drawRegionsStep(){for(let i=0;i<Math.ceil(this.gridSize/50);i++){var s=this.regionsOrdered[this.currentRegion].length,e=this.currentRegion%(2*this.gridSize)/(2*this.gridSize),r=1===s?.5:Math.sqrt(this.regionSizes.indexOf(s)/(this.numUniqueRegionSizes-2)),e=hsvToRgb(e,1,r);this.wilson.ctx.fillStyle=convertColor(0,0,0);for(let i=0;i<s;i++){var o=this.regionsOrdered[this.currentRegion][i][0],n=this.regionsOrdered[this.currentRegion][i][1];this.wilson.ctx.fillRect(this.resolution/this.gridSize*n,this.resolution/this.gridSize*o,this.resolution/this.gridSize,this.resolution/this.gridSize)}this.wilson.ctx.fillStyle=convertColor(...e);for(let t=0;t<s;t++){var h=this.regionsOrdered[this.currentRegion][t][0],l=this.regionsOrdered[this.currentRegion][t][1];this.wilson.ctx.fillRect(this.resolution/this.gridSize*l+this.lineWidth/2,this.resolution/this.gridSize*h+this.lineWidth/2,this.resolution/this.gridSize-this.lineWidth,this.resolution/this.gridSize-this.lineWidth)}if(this.currentRegion++,this.currentRegion===this.numRegions)return}this.currentRegion<this.numRegions&&(this.animationPaused||requestAnimationFrame(this.drawRegionsStep.bind(this)))}switchFullscreen(){this.resume()}async beforeSwitchFullscreen(){this.animationPaused=!0,await new Promise(resolve=>setTimeout(resolve,33))}}export{HitomezashiPatterns};