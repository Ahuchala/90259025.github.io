import{AnimationFrameApplet}from"/scripts/applets/animationFrameApplet.min.js";import{hsvToRgb}from"/scripts/applets/applet.min.js";import{convertColor}from"/scripts/src/browser.min.js";import{WilsonCPU}from"/scripts/wilson.min.js";class DominoShuffling extends AnimationFrameApplet{resolution=2e3;diamondSize=20;useSmoothColors=!0;marginSize=.05;aztecDiamond=[];newDiamond=[];hue=[];newHue=[];age=[];newAge=[];currentDiamondSize=1;frame=0;framesPerAnimationStep=1;constructor({canvas}){super(canvas);var i={canvasWidth:this.resolution,fullscreenOptions:{onSwitch:this.switchFullscreen.bind(this),beforeSwitch:this.beforeSwitchFullscreen.bind(this),useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"}};this.wilson=new WilsonCPU(this.canvas,i)}run({resolution,diamondSize,useSmoothColors}){this.resolution=resolution,this.wilson.resizeCanvas({width:this.resolution}),this.diamondSize=diamondSize,this.framesPerAnimationStep=Math.ceil(100/this.diamondSize),this.useSmoothColors=useSmoothColors,this.aztecDiamond=new Array(2*this.diamondSize),this.newDiamond=new Array(2*this.diamondSize),this.age=new Array(2*this.diamondSize),this.newAge=new Array(2*this.diamondSize),this.hue=new Array(2*this.diamondSize),this.newHue=new Array(2*this.diamondSize);for(let t=0;t<2*this.diamondSize;t++){this.aztecDiamond[t]=new Array(2*this.diamondSize),this.newDiamond[t]=new Array(2*this.diamondSize),this.age[t]=new Array(2*this.diamondSize),this.newAge[t]=new Array(2*this.diamondSize),this.hue[t]=new Array(2*this.diamondSize),this.newHue[t]=new Array(2*this.diamondSize);for(let i=0;i<2*this.diamondSize;i++)this.aztecDiamond[t][i]=0,this.age[t][i]=0,this.hue[t][i]=0}Math.random()<.5?(this.aztecDiamond[this.diamondSize-1][this.diamondSize-1]=-1,this.aztecDiamond[this.diamondSize][this.diamondSize-1]=1,this.age[this.diamondSize-1][this.diamondSize-1]=1,this.age[this.diamondSize][this.diamondSize-1]=1,this.useSmoothColors?(this.hue[this.diamondSize-1][this.diamondSize-1]=.75-Math.atan2(-.5,-.5)/(2*Math.PI),this.hue[this.diamondSize][this.diamondSize-1]=.75-Math.atan2(.5,-.5)/(2*Math.PI)):(this.hue[this.diamondSize-1][this.diamondSize-1]=0,this.hue[this.diamondSize][this.diamondSize-1]=.5)):(this.aztecDiamond[this.diamondSize-1][this.diamondSize-1]=-2,this.aztecDiamond[this.diamondSize-1][this.diamondSize]=2,this.age[this.diamondSize-1][this.diamondSize-1]=1,this.age[this.diamondSize-1][this.diamondSize]=1,this.useSmoothColors?(this.hue[this.diamondSize-1][this.diamondSize-1]=.75-Math.atan2(-.5,-.5)/(2*Math.PI),this.hue[this.diamondSize-1][this.diamondSize]=.75-Math.atan2(-.5,.5)/(2*Math.PI)):(this.hue[this.diamondSize-1][this.diamondSize-1]=.25,this.hue[this.diamondSize-1][this.diamondSize]=.75)),this.currentDiamondSize=1,this.frame=this.framesPerAnimationStep-1,this.resume()}drawFrame(){this.frame++,this.frame===this.framesPerAnimationStep&&(this.frame=0,this.moveDominos(),this.fillSpaces(),this.wilson.ctx.fillStyle=convertColor(0,0,0),this.wilson.ctx.fillRect(0,0,this.resolution,this.resolution),this.drawDiamond()),0===this.frame&&this.currentDiamondSize===this.diamondSize-1?(this.wilson.ctx.fillStyle=convertColor(0,0,0),this.wilson.ctx.fillRect(0,0,this.resolution,this.resolution),this.drawDiamond()):this.needNewFrame=!0}drawDiamond(){for(let s=-this.currentDiamondSize;s<this.currentDiamondSize;s++)for(let i=-this.currentDiamondSize;i<this.currentDiamondSize;i++){var t=s+this.diamondSize,e=i+this.diamondSize;0!==this.aztecDiamond[t][e]&&(1===Math.abs(this.aztecDiamond[t][e])?this.drawDomino(t,e,!0):this.drawDomino(t,e,!1))}}drawDomino(row,col,isHorizontal){var i=this.hue[row][col],t=1-.8*Math.pow((this.age[row][col]-1)/this.currentDiamondSize,4),i=hsvToRgb(i,t,1),t=(this.wilson.ctx.fillStyle=convertColor(...i),this.resolution*(.1+(col+this.marginSize)/(2*this.diamondSize)*.8)),i=this.resolution*(.1+(row+this.marginSize)/(2*this.diamondSize)*.8);isHorizontal?this.wilson.ctx.fillRect(t,i,this.resolution*(2-2*this.marginSize)/(2*this.diamondSize)*.8,this.resolution*(1-2*this.marginSize)/(2*this.diamondSize)*.8):this.wilson.ctx.fillRect(t,i,this.resolution*(1-2*this.marginSize)/(2*this.diamondSize)*.8,this.resolution*(2-2*this.marginSize)/(2*this.diamondSize)*.8)}moveDominos(){for(let t=0;t<2*this.diamondSize;t++)for(let i=0;i<2*this.diamondSize;i++)this.newDiamond[t][i]=0,this.newAge[t][i]=0,this.newHue[t][i]=0;for(let e=0;e<2*this.diamondSize;e++)for(let i=0;i<2*this.diamondSize;i++)0!==this.aztecDiamond[e][i]&&(1===Math.abs(this.aztecDiamond[e][i])?this.aztecDiamond[e+this.aztecDiamond[e][i]][i]===-this.aztecDiamond[e][i]&&(this.aztecDiamond[e+this.aztecDiamond[e][i]][i]=0,this.aztecDiamond[e][i]=0):this.aztecDiamond[e][i+Math.sign(this.aztecDiamond[e][i])]===-this.aztecDiamond[e][i]&&(this.aztecDiamond[e][i+Math.sign(this.aztecDiamond[e][i])]=0,this.aztecDiamond[e][i]=0));for(let s=0;s<2*this.diamondSize;s++)for(let i=0;i<2*this.diamondSize;i++)0!==this.aztecDiamond[s][i]&&(1===Math.abs(this.aztecDiamond[s][i])?(this.newDiamond[s+this.aztecDiamond[s][i]][i]=this.aztecDiamond[s][i],this.newAge[s+this.aztecDiamond[s][i]][i]=this.age[s][i],this.newHue[s+this.aztecDiamond[s][i]][i]=this.hue[s][i]):(this.newDiamond[s][i+Math.sign(this.aztecDiamond[s][i])]=this.aztecDiamond[s][i],this.newAge[s][i+Math.sign(this.aztecDiamond[s][i])]=this.age[s][i],this.newHue[s][i+Math.sign(this.aztecDiamond[s][i])]=this.hue[s][i]));for(let a=0;a<2*this.diamondSize;a++)for(let i=0;i<2*this.diamondSize;i++)this.aztecDiamond[a][i]=this.newDiamond[a][i],this.age[a][i]=this.newAge[a][i],this.hue[a][i]=this.newHue[a][i];this.currentDiamondSize++}fillSpaces(){for(let s=-this.currentDiamondSize;s<this.currentDiamondSize;s++)for(let i=-this.currentDiamondSize;i<this.currentDiamondSize;i++){var t,e;Math.abs(s+.5)+Math.abs(i+.5)<=this.currentDiamondSize&&Math.abs(s+1.5)+Math.abs(i+.5)<=this.currentDiamondSize&&Math.abs(s+.5)+Math.abs(i+1.5)<=this.currentDiamondSize&&Math.abs(s+1.5)+Math.abs(i+1.5)<=this.currentDiamondSize&&(t=s+this.diamondSize,e=i+this.diamondSize,0===this.aztecDiamond[t][e])&&0===this.aztecDiamond[t+1][e]&&0===this.aztecDiamond[t][e+1]&&0===this.aztecDiamond[t+1][e+1]&&2!==Math.abs(this.aztecDiamond[t-1][e])&&2!==Math.abs(this.aztecDiamond[t-1][e+1])&&1!==Math.abs(this.aztecDiamond[t][e-1])&&1!==Math.abs(this.aztecDiamond[t+1][e-1])&&this.fillSpace(t,e)}}fillSpace(row,col){Math.random()<.5?(this.aztecDiamond[row][col]=-1,this.aztecDiamond[row+1][col]=1,this.age[row][col]=this.currentDiamondSize,this.age[row+1][col]=this.currentDiamondSize,this.useSmoothColors?(this.hue[row][col]=.75-Math.atan2(row+.5-this.diamondSize,col+.5-this.diamondSize)/(2*Math.PI),this.hue[row+1][col]=.75-Math.atan2(row+1.5-this.diamondSize,col+.5-this.diamondSize)/(2*Math.PI)):(this.hue[row][col]=0,this.hue[row+1][col]=.5)):(this.aztecDiamond[row][col]=-2,this.aztecDiamond[row][col+1]=2,this.age[row][col]=this.currentDiamondSize,this.age[row][col+1]=this.currentDiamondSize,this.useSmoothColors?(this.hue[row][col]=.75-Math.atan2(row+.5-this.diamondSize,col+.5-this.diamondSize)/(2*Math.PI),this.hue[row][col+1]=.75-Math.atan2(row+.5-this.diamondSize,col+1.5-this.diamondSize)/(2*Math.PI)):(this.hue[row][col]=.25,this.hue[row][col+1]=.75))}switchFullscreen(){this.resume()}async beforeSwitchFullscreen(){this.animationPaused=!0,await new Promise(resolve=>setTimeout(resolve,33))}}export{DominoShuffling};