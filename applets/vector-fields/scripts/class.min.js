import{doubleEncodingGlsl,getGlslBundle,loadGlsl}from"../../../scripts/src/complexGlsl.min.js";import{AnimationFrameApplet}from"/scripts/applets/animationFrameApplet.min.js";import{getFloatGlsl,getMaxGlslString,tempShader}from"/scripts/applets/applet.min.js";import{WilsonGPU}from"/scripts/wilson.min.js";class VectorFields extends AnimationFrameApplet{loadPromise;resolution=500;subpixelWorldCenterMovement=[0,0];lastWorldCenterX;lastWorldCenterY;lastWorldWidth;lastScale=1;needTemporaryDim=!1;lastGeneratedCanvasWidth;lastGeneratedCanvasHeight;numParticles=0;maxParticles=5e3;loopEdges=!1;particleDilation;needStepSize=!0;dt=.00375;lifetime=150;particles=[];freeParticleSlots=[];updateTexture;panZoomDimTexture;updateCanvas;panZoomDimCanvas;wilsonUpdate;wilsonPanZoomDim;timeElapsedHistoryLength=60;lastTimeElapsed=new Array(this.timeElapsedHistoryLength);averageTimeElapsed;frame=0;drawFrameCallback=()=>{};constructor({canvas,loopEdges=!1}){super(canvas),this.loopEdges=loopEdges,this.panZoomDimCanvas=this.createHiddenCanvas(),this.updateCanvas=this.createHiddenCanvas();this.wilsonUpdate=new WilsonGPU(this.updateCanvas,{shader:tempShader,canvasWidth:100,canvasHeight:100});var e={shader:`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			uniform sampler2D uTexture;
			
			uniform float dimAmount;
			uniform float scale;
			uniform vec2 uvStep;
			uniform float temporaryDimFactor;
			
			void main(void)
			{
				vec2 texCoord = ((scale * uv + vec2(1.0, 1.0)) / 2.0) + uvStep;
				
				if (texCoord.x >= 0.0 && texCoord.x < 1.0 && texCoord.y >= 0.0 && texCoord.y < 1.0)
				{
					vec3 v = texture2D(uTexture, texCoord).xyz;
					
					gl_FragColor = vec4(
						(v.x - dimAmount) * temporaryDimFactor,
						v.y,
						v.z,
						1.0
					);
					
					return;
				}
				
				gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
		`,uniforms:{dimAmount:1/255,scale:1,uvStep:[0,0],temporaryDimFactor:1},canvasWidth:this.resolution,fullscreenOptions:{fillScreen:!0,animate:!1,closeWithEscape:!1}},e=(this.wilsonPanZoomDim=new WilsonGPU(this.panZoomDimCanvas,e),this.wilsonPanZoomDim.canvas.parentElement.parentElement.parentElement.style.setProperty("display","none","important"),{shader:tempShader,canvasWidth:this.resolution,worldWidth:2*Math.PI,minWorldWidth:.5,maxWorldWidth:20,minWorldHeight:.5,maxWorldHeight:20,onResizeCanvas:()=>requestAnimationFrame(()=>this.generateNewField({})),interactionOptions:{useForPanAndZoom:!0,onPanAndZoom:()=>this.needNewFrame=!0},draggableOptions:{draggables:{draggableArg:[0,0]},callbacks:{drag:this.onDragDraggable.bind(this)}},fullscreenOptions:{fillScreen:!0,beforeSwitch:this.beforeSwitchFullscreen.bind(this),onSwitch:this.switchFullscreen.bind(this),useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"}});this.wilson=new WilsonGPU(canvas,e),this.wilson.draggables.draggableArg.element.style.display="none",this.loadPromise=loadGlsl()}async run({generatingCode,resolution=500,maxParticles=6e3,dt=.00375,lifetime=150,worldWidth=2*Math.PI,worldCenterX=0,worldCenterY=0,particleDilation=void 0,appendGlsl=""}){await this.loadPromise,this.dt=dt,this.resolution=resolution,this.particleDilation=particleDilation;var e=-1!==generatingCode.indexOf("draggableArg"),t=(this.wilson.resizeCanvas({width:this.resolution}),this.wilsonPanZoomDim.resizeCanvas({width:this.resolution}),`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			uniform sampler2D uTexture;
			
			uniform float dt;
			
			uniform vec2 draggableArg;
			
			
			
			${getGlslBundle(generatingCode)}
			
			${doubleEncodingGlsl}
			
			vec2 f(float x, float y)
			{
				${appendGlsl}

				return vec2${generatingCode};
			}
			
			
			
			void main(void)
			{
				vec4 sample = texture2D(uTexture, (uv + vec2(1.0, 1.0)) / 2.0);
				
				if (int(sample.z) == 0)
				{
					return;
				}
				
				vec2 d = f(sample.x, sample.y);
		`),i=`
				${t}
				
				gl_FragColor = encodeFloat(dt * d.y + sample.y);
			}
		`,s=`
				${t}
				
				gl_FragColor = encodeFloat((atan(d.y, d.x) + 3.14159265) / 6.28318531);
			}
		`,a=`
				${t}
				
				gl_FragColor = encodeFloat(1.0 - exp(-1.2 * (d.x * d.x + d.y * d.y)));
			}
		`,r=`
				${t}
				
				gl_FragColor = encodeFloat(1.0 - exp(-1.2 * .9 * (d.x * d.x + d.y * d.y)));
			}
		`,t=(this.wilsonUpdate.loadShader({id:"updateX",shader:`
				${t}
				
				gl_FragColor = encodeFloat(dt * d.x + sample.x);
			}
		`,uniforms:{dt:this.dt,...e?{draggableArg:[0,0]}:{}}}),this.wilsonUpdate.loadShader({id:"updateY",shader:i,uniforms:{dt:this.dt,...e?{draggableArg:[0,0]}:{}}}),this.wilsonUpdate.loadShader({id:"updateH",shader:s,uniforms:{...e?{draggableArg:[0,0]}:{}}}),this.wilsonUpdate.loadShader({id:"updateS",shader:a,uniforms:{...e?{draggableArg:[0,0]}:{}}}),this.wilsonUpdate.loadShader({id:"updateS2",shader:r,uniforms:{...e?{draggableArg:[0,0]}:{}}}),this.getSamplingGlsl()),i=`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			uniform sampler2D uTexture;
			
			uniform float maxBrightness;

			uniform vec2 stepSize;
			
			vec3 hsvToRgb(vec3 c)
			{
				vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
				vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
				return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
			}

			vec3 getPixel(vec2 uv)
			{
				vec3 v = texture2D(uTexture, (vec2(1.0 + uv.x, 1.0 - uv.y)) / 2.0).xyz;

				return hsvToRgb(vec3(v.y, v.z, v.x / maxBrightness));
			}
			
			void main(void)
			{
				${t}
			}
		`;this.needStepSize=-1!==t.indexOf("stepSize"),this.wilson.loadShader({id:"draw",shader:i,uniforms:{maxBrightness:this.lifetime/255,...this.needStepSize?{stepSize:[2/this.resolution,2/this.resolution]}:{}}}),this.wilson.setUniforms({maxBrightness:this.lifetime/255}),this.wilson.draggables.draggableArg.element.style.display=e?"block":"none",this.wilson.resizeWorld({width:worldWidth,centerX:worldCenterX,centerY:worldCenterY}),this.generateNewField({maxParticles:maxParticles,dt:dt,lifetime:lifetime,forceRegenerate:!0})}getSamplingGlsl(){var t=this.particleDilation??Math.floor(this.resolution/500);if(0===t)return`
				gl_FragColor = vec4(getPixel(uv), 1.0);
			`;if(1===t)return`
				vec3 distance1 = getPixel(uv);

				// Make a 2x2 square down and right.
				vec3 distance2 = getPixel(uv + vec2(stepSize.x, 0.0));
				vec3 distance3 = getPixel(uv + vec2(0.0, stepSize.y));
				vec3 distance4 = getPixel(uv + stepSize);

				gl_FragColor = vec4(${getMaxGlslString("distance",4)}, 1.0);
			`;let i="",s=0;for(let a=1-t;a<t;a++)for(let e=1-t;e<t;e++)(t-.5)*(t-.5)<a*a+e*e||(s++,i+=`
					vec3 distance${s} = getPixel(
						uv + vec2(
							${getFloatGlsl(a)} * stepSize.x,
							${getFloatGlsl(e)} * stepSize.y
						)
					);
				`);return i+=`
			gl_FragColor = vec4(${getMaxGlslString("distance",s)}, 1.0);
		`}async generateNewField({maxParticles=this.maxParticles,dt=this.dt,lifetime=this.lifetime,forceRegenerate=!1}){if(forceRegenerate||this.wilson.canvasWidth===this.wilsonPanZoomDim.canvasWidth&&this.wilson.canvasHeight===this.wilsonPanZoomDim.canvasHeight&&this.wilson.canvasWidth!==this.lastGeneratedCanvasWidth&&this.wilson.canvasHeight!==this.lastGeneratedCanvasHeight){await this.loadPromise,this.lastGeneratedCanvasWidth=this.wilson.canvasWidth,this.lastGeneratedCanvasHeight=this.wilson.canvasHeight,this.maxParticles=maxParticles,this.dt=dt,this.lifetime=lifetime,this.wilson.setUniforms({maxBrightness:this.lifetime/255,...this.needStepSize?{stepSize:[2/this.wilson.canvasWidth,2/this.wilson.canvasHeight]}:{}}),this.numParticles=0;var s=Math.ceil(Math.sqrt(maxParticles));this.wilsonUpdate.resizeCanvas({width:s}),this.wilsonUpdate.createFramebufferTexturePair({id:"update",textureType:"float"}),this.wilsonUpdate.useFramebuffer(null),this.wilsonUpdate.useTexture("update"),this.wilsonPanZoomDim.createFramebufferTexturePair({id:"panZoomDim",textureType:"unsignedByte"}),this.wilsonPanZoomDim.useFramebuffer(null),this.wilsonPanZoomDim.useTexture("panZoomDim"),this.wilson.createFramebufferTexturePair({id:"draw",textureType:"unsignedByte"}),this.wilson.useFramebuffer(null),this.wilson.useTexture("draw"),this.lastWorldCenterX=this.wilson.worldCenterX,this.lastWorldCenterY=this.wilson.worldCenterY,this.lastWorldWidth=this.wilson.worldWidth,this.particles=new Array(this.maxParticles),this.freeParticleSlots=new Array(this.maxParticles);for(let e=0;e<this.maxParticles;e++)this.particles[e]=[0,0,0],this.freeParticleSlots[e]=e;this.updateTexture=new Float32Array(this.wilsonUpdate.canvasWidth*this.wilsonUpdate.canvasHeight*4);for(let t=0;t<this.wilsonUpdate.canvasHeight;t++)for(let e=0;e<this.wilsonUpdate.canvasWidth;e++){var a=this.wilsonUpdate.canvasWidth*t+e;this.updateTexture[4*a]=0,this.updateTexture[4*a+1]=0,this.updateTexture[4*a+2]=0,this.updateTexture[4*a+3]=0}this.panZoomDimTexture=new Uint8Array(this.wilson.canvasWidth*this.wilson.canvasHeight*4);for(let i=0;i<this.wilson.canvasHeight;i++)for(let e=0;e<this.wilson.canvasWidth;e++){var r=this.wilson.canvasWidth*i+e;this.panZoomDimTexture[4*r]=0,this.panZoomDimTexture[4*r+1]=0,this.panZoomDimTexture[4*r+2]=0}this.resume()}}drawFrame(timeElapsed){if(this.wilsonUpdate.setUniforms({dt:this.dt*timeElapsed/6.944},"updateX"),this.wilsonUpdate.setUniforms({dt:this.dt*timeElapsed/6.944},"updateY"),this.frame<this.timeElapsedHistoryLength){if(this.lastTimeElapsed[this.frame]=Math.min(timeElapsed,16),this.frame===this.timeElapsedHistoryLength-1){let e=0;for(let t=0;t<this.timeElapsedHistoryLength;t++)e+=this.lastTimeElapsed[t];this.wilsonPanZoomDim.setUniforms({dimAmount:e/this.timeElapsedHistoryLength/1770.72})}this.frame++}if(this.numParticles<this.maxParticles){var t=Math.min(Math.ceil(this.maxParticles/80),this.maxParticles-this.numParticles);for(let e=this.freeParticleSlots.length-t;e<this.freeParticleSlots.length;e++)this.createParticle(this.freeParticleSlots[e]);this.freeParticleSlots.splice(this.freeParticleSlots.length-t,t)}this.subpixelWorldCenterMovement[0]+=(this.wilson.worldCenterX-this.lastWorldCenterX)/this.wilson.worldWidth*this.wilson.canvasWidth,this.subpixelWorldCenterMovement[1]+=(this.wilson.worldCenterY-this.lastWorldCenterY)/this.wilson.worldHeight*this.wilson.canvasHeight;var t=Math.sign(this.subpixelWorldCenterMovement[0])*Math.floor(Math.abs(this.subpixelWorldCenterMovement[0])),e=Math.sign(this.subpixelWorldCenterMovement[1])*Math.floor(Math.abs(this.subpixelWorldCenterMovement[1])),i=(this.subpixelWorldCenterMovement[0]=Math.sign(this.subpixelWorldCenterMovement[0])*(Math.abs(this.subpixelWorldCenterMovement[0])-Math.abs(t)),this.subpixelWorldCenterMovement[1]=Math.sign(this.subpixelWorldCenterMovement[1])*(Math.abs(this.subpixelWorldCenterMovement[1])-Math.abs(e)),this.wilson.worldWidth/this.lastWorldWidth);this.wilsonPanZoomDim.setUniforms({uvStep:[t/this.wilson.canvasWidth,-e/this.wilson.canvasHeight],scale:i,temporaryDimFactor:Math.min(i,1)*(this.needTemporaryDim?.96:1)}),this.lastWorldCenterX=this.wilson.worldCenterX,this.lastWorldCenterY=this.wilson.worldCenterY,this.lastWorldWidth=this.wilson.worldWidth,this.lastScale=i,this.needTemporaryDim=!1,this.drawField(timeElapsed),this.drawFrameCallback(),this.needNewFrame=!0}createParticle(index){this.particles[index][0]=this.wilson.worldCenterX+this.wilson.worldWidth*(Math.random()-.5),this.particles[index][1]=this.wilson.worldCenterY+this.wilson.worldHeight*(Math.random()-.5),this.particles[index][2]=Math.round(this.lifetime*(.5*Math.random()+.75)),this.numParticles++}destroyParticle(index){this.particles[index][2]=0,this.freeParticleSlots.push(index),this.numParticles--}updateParticles(){var i=100*Math.max(this.lastScale-1,0)+1;for(let d=0;d<this.wilsonUpdate.canvasHeight;d++)for(let e=0;e<this.wilsonUpdate.canvasWidth;e++){var t=this.wilsonUpdate.canvasWidth*d+e;t<this.particles.length&&this.particles[t][2]?(this.updateTexture[4*t]=this.particles[t][0],this.updateTexture[4*t+1]=this.particles[t][1],this.updateTexture[4*t+2]=1):this.updateTexture[4*t+2]=0}this.wilsonUpdate.setTexture({id:"update",data:this.updateTexture}),this.wilsonUpdate.useShader("updateX"),this.wilsonUpdate.drawFrame();var s=new Float32Array(this.wilsonUpdate.readPixels().buffer),a=(this.wilsonUpdate.useShader("updateY"),this.wilsonUpdate.drawFrame(),new Float32Array(this.wilsonUpdate.readPixels().buffer)),r=(this.wilsonUpdate.useShader("updateH"),this.wilsonUpdate.drawFrame(),new Float32Array(this.wilsonUpdate.readPixels().buffer)),l=(this.wilsonUpdate.useShader("updateS"),this.wilsonUpdate.drawFrame(),new Float32Array(this.wilsonUpdate.readPixels().buffer)),n=(this.wilsonUpdate.useShader("updateS2"),this.wilsonUpdate.drawFrame(),new Float32Array(this.wilsonUpdate.readPixels().buffer));for(let m=0;m<this.wilsonUpdate.canvasHeight;m++)for(let e=0;e<this.wilsonUpdate.canvasWidth;e++){var o,h=this.wilsonUpdate.canvasWidth*m+e;if(h<this.particles.length&&this.particles[h][2]){this.particles[h][0]=s[h],this.particles[h][1]=a[h];let[e,t]=this.wilson.interpolateWorldToCanvas(this.particles[h]);this.loopEdges&&(e>=this.wilson.canvasHeight?(e=2*this.wilson.canvasHeight-2-e,t+=Math.floor(this.wilson.canvasWidth/2)):e<0&&(e=Math.abs(e),t+=Math.floor(this.wilson.canvasWidth/2)),t>=this.wilson.canvasWidth?t-=this.wilson.canvasWidth:t<0&&(t+=this.wilson.canvasWidth)),0<=e&&e<this.wilson.canvasHeight&&0<=t&&t<this.wilson.canvasWidth&&(o=e*this.wilson.canvasWidth+t,this.panZoomDimTexture[4*o]=this.lifetime,this.panZoomDimTexture[4*o+1]=255*r[h],this.panZoomDimTexture[4*o+2]=255*Math.max(l[h],n[h]),this.particles[h][2]-=i,!(this.particles[h][2]<=0))||this.destroyParticle(h)}}}drawField(timeElapsed){this.wilsonPanZoomDim.setTexture({id:"panZoomDim",data:this.panZoomDimTexture}),this.wilsonPanZoomDim.drawFrame(),this.panZoomDimTexture=this.wilsonPanZoomDim.readPixels(),this.updateParticles(timeElapsed),this.wilson.setTexture({id:"draw",data:this.panZoomDimTexture}),this.wilson.drawFrame()}onDragDraggable({x,y}){for(const e of["updateX","updateY","updateH","updateS","updateS2"])this.wilsonUpdate.setUniforms({draggableArg:[x,y]},e);this.needTemporaryDim=!0}switchFullscreen(isFullscreen){isFullscreen?this.wilsonPanZoomDim.enterFullscreen():this.wilsonPanZoomDim.exitFullscreen(),requestAnimationFrame(()=>this.generateNewField({}))}async beforeSwitchFullscreen(){this.pause(),await new Promise(resolve=>setTimeout(resolve,33))}}export{VectorFields};