import{Applet,hsvToRgb}from"../../../scripts/applets/applet.min.js";import{convertColor}from"/scripts/src/browser.min.js";import{addTemporaryWorker}from"/scripts/src/main.min.js";import{WilsonCPU}from"/scripts/wilson.min.js";class MagicCarpets extends Applet{gridSize;maxCageSize;uniqueSolution;cages=[];currentlyDrawing=!1;cellSize=200;delay;cagesPerDraw;cageIndex;webWorker;constructor({canvas}){super(canvas);this.wilson=new WilsonCPU(canvas,{canvasWidth:500}),this.run()}async run({gridSize=8,maxCageSize=16,uniqueSolution=!0}){if(!this.currentlyDrawing){this.gridSize=gridSize,this.maxCageSize=maxCageSize,this.cellSize=Math.min(200,Math.floor(4e3/this.gridSize));const i=this.gridSize*this.cellSize+9;this.wilson.resizeCanvas({width:i}),this.webWorker=addTemporaryWorker("/applets/magic-carpets/scripts/worker.js"),this.webWorker.onmessage=e=>{this.cages=e.data[0],this.wilson.ctx.clearRect(0,0,i,i),this.drawGrid()},this.webWorker.postMessage([this.gridSize,this.maxCageSize,uniqueSolution])}}drawGrid(rectanglesOnly=!1){var e=this.gridSize*this.cellSize+9;if(rectanglesOnly?this.wilson.ctx.clearRect(0,0,e,e):(this.wilson.ctx.fillStyle=convertColor(255,255,255),this.wilson.ctx.fillRect(0,0,e,e)),this.wilson.ctx.fillStyle=convertColor(0,0,0),!rectanglesOnly)for(let i=0;i<=this.gridSize;i++)this.wilson.ctx.fillRect(this.cellSize*i+3,0,4,9+e),this.wilson.ctx.fillRect(0,this.cellSize*i+3,9+e,4);if(this.wilson.ctx.fillRect(0,0,this.cellSize*this.gridSize+10,10),this.wilson.ctx.fillRect(0,this.cellSize*this.gridSize,this.cellSize*this.gridSize+10,10),this.wilson.ctx.fillRect(0,0,10,this.cellSize*this.gridSize+10),this.wilson.ctx.fillRect(this.cellSize*this.gridSize,0,10,this.cellSize*this.gridSize+10),!rectanglesOnly){this.wilson.ctx.font=.6*this.cellSize+"px sans-serif";for(let i=0;i<this.cages.length;i++)this.drawNumber(i)}this.currentlyDrawing=!1}drawNumber(i){var e=this.cages[i][0]+this.cages[i][4],s=this.cages[i][1]+this.cages[i][5],t=""+this.cages[i][2]*this.cages[i][3],l=this.wilson.ctx.measureText(t);this.wilson.ctx.fillText(t,this.cellSize*s+(this.cellSize-l.width)/2+5,this.cellSize*(e+1)-(this.cellSize-l.actualBoundingBoxAscent-l.actualBoundingBoxDescent)/2+4)}drawSolution(rectanglesOnly=!1){var i;this.currentlyDrawing||(this.currentlyDrawing=!0,i=this.gridSize*this.cellSize+9,rectanglesOnly?this.wilson.ctx.clearRect(0,0,i,i):(this.wilson.ctx.fillStyle=convertColor(255,255,255),this.wilson.ctx.fillRect(0,0,i,i)),this.drawGrid(rectanglesOnly),this.delay=Math.floor(250/this.cages.length),this.cagesPerDraw=Math.ceil(this.cages.length/250),this.cageIndex=0,this.drawCage(0,rectanglesOnly))}drawCage(index,rectanglesOnly){var i,e,s,t,l,c,r,h,n,a;index===this.cages.length?this.currentlyDrawing=!1:(l=hsvToRgb(index/this.cages.length*6/7,1,1),this.wilson.ctx.fillStyle=convertColor(...l,rectanglesOnly?.5:.2),i=this.cages[index][0]*this.cellSize,e=this.cages[index][1]*this.cellSize,s=this.cages[index][2]*this.cellSize,t=this.cages[index][3]*this.cellSize,this.wilson.ctx.fillRect(10+e,10+i,t-10,s-10),l=hsvToRgb(index/this.cages.length*6/7,1,.9),this.wilson.ctx.fillStyle=convertColor(...l),l=0===this.cages[index][0]?0:5,c=0===this.cages[index][1]?0:5,r=this.cages[index][0]+this.cages[index][2]===this.gridSize||0===this.cages[index][0]?0:5,h=this.cages[index][1]+this.cages[index][3]===this.gridSize||0===this.cages[index][1]?0:5,n=this.cages[index][0]+this.cages[index][2]===this.gridSize&&0===this.cages[index][0]?5:0,a=this.cages[index][1]+this.cages[index][3]===this.gridSize&&0===this.cages[index][1]?5:0,this.wilson.ctx.fillRect(10+e-c,10+i-l,t-5+h-a,10),this.wilson.ctx.fillRect(10+e-c,10+i-l,10,s-5+r-n),this.wilson.ctx.fillRect(e+t-5-c+h-a,10+i-l,10,s-5+r-n),this.wilson.ctx.fillRect(10+e-c+h,i+s-5-l+r-n,t-5-a,10),this.cageIndex++,this.cageIndex%this.cagesPerDraw==0?setTimeout(()=>this.drawCage(index+1,rectanglesOnly),this.delay):this.drawCage(index+1,rectanglesOnly))}}export{MagicCarpets};