import{AnimationFrameApplet}from"/scripts/applets/animationFrameApplet.min.js";import{WilsonGPU}from"/scripts/wilson.min.js";class SortingAlgorithms extends AnimationFrameApplet{resolution=2e3;dataLength;data=[];brightness=[];maxBrightness=40;currentGenerator;minFrequency=30;maxFrequency=600;doPlaySound=!0;timeElapsed=0;algorithms={bubble:this.bubbleSort,insertion:this.insertionSort,selection:this.selectionSort,heap:this.heapsort,merge:this.mergeSort,quick:this.quicksort,shell:this.shellsort,cycle:this.cycleSort,msdRadix:this.msdRadixSort,lsdRadix:this.lsdRadixSort,gravity:this.gravitySort};generators=[this.shuffleArray,null,this.verifyArray];currentGeneratorIndex=0;numReads=0;numWrites=0;inFrameOperations=0;operationsPerFrame=1;updateReadsAndWrites=!1;numReadsElement;numWritesElement;changingSound=!1;audioNodes=[];timeoutId;constructor({canvas,numReadsElement,numWritesElement}){super(canvas),this.numReadsElement=numReadsElement,this.numWritesElement=numWritesElement;var t={shader:`
			precision highp float;
			
			varying vec2 uv;
			
			uniform float dataLength;
			
			const float circleSize = .8;
			
			uniform sampler2D uTexture;
			
			
			
			vec3 hsvToRgb(vec3 c)
			{
				vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
				vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
				return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
			}
			
			
			
			void main(void)
			{
				gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
				
				if (length(uv) <= circleSize)
				{
					float sample = mod(atan(uv.y, uv.x) / 6.283, 1.0);
					
					vec4 output1 = texture2D(uTexture, vec2(floor(sample * dataLength) / dataLength, .5));
					vec4 output2 = texture2D(uTexture, vec2(mod(floor(sample * dataLength + 1.0) / dataLength, 1.0), .5));
					
					float brightness = mix(output1.z, output2.z, fract(sample * dataLength));
					
					float h1 = (output1.x * 256.0 + output1.y) / dataLength * 255.0;
					float h2 = (output2.x * 256.0 + output2.y) / dataLength * 255.0;
					
					if (abs(h1 - h2) > .5)
					{
						if (h1 > h2)
						{
							h1 -= 1.0;
						}
						
						else
						{
							h2 -= 1.0;
						}
					}
					
					
					
					float h = mix(h1, h2, fract(sample * dataLength));
					
					float s = clamp((length(uv) / circleSize - .03) * (1.0 - brightness), 0.0, 1.0);
					
					float v = clamp((1.0 - length(uv) / circleSize) * 300.0, 0.0, 1.0);
					
					gl_FragColor = vec4(hsvToRgb(vec3(h, s, v)), 1.0);
				}
			}
		`,uniforms:{dataLength:this.dataLength},canvasWidth:this.resolution,fullscreenOptions:{onSwitch:this.switchFullscreen.bind(this),beforeSwitch:this.beforeSwitchFullscreen.bind(this),useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"}};this.wilson=new WilsonGPU(canvas,t)}run({resolution,algorithm,dataLength,doPlaySound}){this.resolution=resolution,this.generators=[this.shuffleArray.bind(this),this.algorithms[algorithm].bind(this),this.verifyArray.bind(this)],this.currentGeneratorIndex=0;var t=this.dataLength;if(this.dataLength=dataLength,this.doPlaySound=doPlaySound,this.destroyAudioNodes(),clearTimeout(this.timeoutId),this.wilson.resizeCanvas({width:this.resolution}),this.dataLength!==t){this.data=new Array(this.dataLength),this.brightness=new Array(this.dataLength);for(let t=0;t<this.dataLength;t++)this.data[t]=t,this.brightness[t]=0;this.wilson.createFramebufferTexturePair({id:"data",width:this.dataLength,height:1,textureType:"unsignedByte"}),this.wilson.useFramebuffer(null),this.wilson.setUniforms({dataLength:this.dataLength})}this.numReads=0,this.numWrites=0,this.inFrameOperations=0,this.updateReadsAndWrites=!1,this.numReadsElement&&this.numWritesElement&&(this.numReadsElement.textContent="0",this.numWritesElement.textContent="0"),this.createAudioNodes(),this.audioNodes[this.currentGeneratorIndex][1].start(0),this.doPlaySound||this.audioNodes[this.currentGeneratorIndex][2].gain.linearRampToValueAtTime(1e-4,this.audioNodes[this.currentGeneratorIndex][0].currentTime+1e-5),this.currentGenerator=this.generators[0](),this.resume()}prepareFrame(timeElapsed){this.timeElapsed=timeElapsed}drawFrame(){var t=new Uint8Array(4*this.dataLength);for(let i=0;i<this.dataLength;i++)t[4*i]=Math.floor(this.data[i]/256),t[4*i+1]=this.data[i]%256,t[4*i+2]=Math.floor(this.brightness[i]/this.maxBrightness*256);this.wilson.setTexture({id:"data",data:t}),this.wilson.drawFrame(),this.decreaseBrightness(),this.updateReadsAndWrites&&this.numReadsElement&&this.numWritesElement&&(this.numReadsElement.textContent=this.numReads,this.numWritesElement.textContent=this.numWrites),this.changingSound||this.currentGenerator.next(),this.needNewFrame=!0}createAudioNodes(){for(let a=0;a<this.generators.length;a++){var t=new AudioContext,i=t.createOscillator(),e=(i.type="sine",i.frequency.value=50,t.createGain());i.connect(e),e.connect(t.destination),this.audioNodes.push([t,i,e])}}destroyAudioNodes(){for(const t of this.audioNodes)t[0].close();this.audioNodes=[],this.changingSound=!1}setDoPlaySound(newDoPlaySound){this.doPlaySound=newDoPlaySound,this.audioNodes[this.currentGeneratorIndex]&&this.audioNodes[this.currentGeneratorIndex][2].gain.linearRampToValueAtTime(this.doPlaySound?1:1e-4,this.audioNodes[this.currentGeneratorIndex][0].currentTime+this.timeElapsed/1e3)}readFromPosition(){this.numReads++}writeToPosition(index,highlight=!0,sound=!0){return highlight&&(this.brightness[index]=this.maxBrightness-1),this.numWrites++,this.inFrameOperations++,this.inFrameOperations>=this.operationsPerFrame&&(this.inFrameOperations=0,sound&&this.playSound(index),!0)}playSound(index){this.doPlaySound&&this.audioNodes[this.currentGeneratorIndex][1].frequency.linearRampToValueAtTime((this.maxFrequency-this.minFrequency)*this.data[index]/this.dataLength+this.minFrequency,this.audioNodes[this.currentGeneratorIndex][0].currentTime+this.timeElapsed/1e3)}decreaseBrightness(){for(let t=0;t<this.dataLength;t++)this.brightness[t]=Math.max(this.brightness[t]-1,0)}advanceGenerator(){this.changingSound=!0,this.audioNodes[this.currentGeneratorIndex][2].gain.linearRampToValueAtTime(1e-4,this.audioNodes[this.currentGeneratorIndex][0].currentTime+this.timeElapsed/1e3),this.currentGeneratorIndex++,this.currentGeneratorIndex<this.generators.length&&(this.timeoutId=setTimeout(()=>{this.audioNodes[this.currentGeneratorIndex][1].start(0),this.doPlaySound||this.audioNodes[this.currentGeneratorIndex][2].gain.linearRampToValueAtTime(1e-4,this.audioNodes[this.currentGeneratorIndex][0].currentTime+1e-5),this.currentGenerator=this.generators[this.currentGeneratorIndex](),this.changingSound=!1},1e3))}switchFullscreen(){this.resume()}async beforeSwitchFullscreen(){this.pause(),await new Promise(resolve=>setTimeout(resolve,33))}*shuffleArray(){this.operationsPerFrame=Math.ceil(this.dataLength/60);for(let e=0;e<this.dataLength-1;e++){var t=Math.floor(Math.random()*(this.dataLength-e-1))+e,i=this.data[e];this.data[e]=this.data[t],this.data[t]=i,this.writeToPosition(e)&&(yield),this.writeToPosition(t)&&(yield)}this.numReads=0,this.numWrites=0,this.updateReadsAndWrites=!0,this.advanceGenerator()}*verifyArray(){this.updateReadsAndWrites=!1,this.operationsPerFrame=Math.ceil(this.dataLength/60);for(let t=0;t<this.dataLength;t++)this.writeToPosition(t)&&(yield),t!==this.dataLength-1&&this.data[t]>this.data[t+1]&&console.log("Not sorted!",this.data);this.advanceGenerator()}*bubbleSort(){for(this.operationsPerFrame=Math.ceil(this.dataLength*this.dataLength/2500);;){let t=!0;for(let i=0;i<this.dataLength-1;i++){var e;this.readFromPosition(i),this.readFromPosition(i+1),this.data[i]>this.data[i+1]&&(t=!1,e=this.data[i],this.data[i]=this.data[i+1],this.data[i+1]=e,this.writeToPosition(i)&&(yield),this.writeToPosition(i+1))&&(yield)}if(t)break}this.advanceGenerator()}*insertionSort(){this.operationsPerFrame=Math.ceil(this.dataLength*this.dataLength/5e3);for(let a=1;a<this.dataLength;a++)if(this.readFromPosition(a),this.readFromPosition(a-1),this.data[a]<this.data[a-1])for(let i=0;i<a;i++)if(this.readFromPosition(i),this.readFromPosition(a),this.data[i]>this.data[a]){var e=this.data[a];for(let t=a;t>i;t--)this.data[t]=this.data[t-1],this.writeToPosition(t)&&(yield);this.data[i]=e,this.writeToPosition(i)&&(yield)}this.advanceGenerator()}*selectionSort(){this.operationsPerFrame=Math.ceil(this.dataLength/1e3);for(let s=0;s<this.dataLength;s++){let t=-1,i=this.dataLength;for(let e=s;e<this.dataLength;e++)this.readFromPosition(e),this.readFromPosition(i),this.data[e]<i&&(i=this.data[e],t=e);var a=this.data[s];this.data[s]=i,this.data[t]=a,this.writeToPosition(s)&&(yield),this.writeToPosition(t)&&(yield)}this.advanceGenerator()}*heapsort(){this.operationsPerFrame=Math.ceil(this.dataLength*Math.log(this.dataLength)/500);for(let o=1;o<this.dataLength;o++){let t=o;for(var i;0!==t&&(i=Math.floor((t-1)/2),this.readFromPosition(t),this.readFromPosition(i),this.data[t]>this.data[i]);){var e=this.data[t];this.data[t]=this.data[i],this.data[i]=e,this.writeToPosition(t)&&(yield),this.writeToPosition(i)&&(yield),t=i}}for(let h=this.dataLength-1;0<=h;h--){var a=this.data[0];this.data[0]=this.data[h],this.data[h]=a,this.writeToPosition(0)&&(yield),this.writeToPosition(h)&&(yield);let t=0;var s;let i=0;for(;;){if(s=1+(r=2*t+1),r>=h)break;if(i=s>=h||(this.readFromPosition(r),this.readFromPosition(s),this.data[r]>this.data[s])?r:s,this.readFromPosition(t),this.readFromPosition(i),!(this.data[t]<this.data[i]))break;var r=this.data[t];this.data[t]=this.data[i],this.data[i]=r,this.writeToPosition(t)&&(yield),this.writeToPosition(i)&&(yield),t=i}}this.advanceGenerator()}*mergeSort(start=0,end=this.dataLength){var t;if(end-start==2)this.readFromPosition(start),this.readFromPosition(end-1),this.data[start]>this.data[end-1]&&(this.writeToPosition(start)&&(yield),this.writeToPosition(end-1)&&(yield),t=this.data[start],this.data[start]=this.data[end-1],this.data[end-1]=t);else if(!(end-start<=1)){this.operationsPerFrame=Math.ceil(this.dataLength*Math.log(this.dataLength)/200);let s=start+Math.floor((end-start)/2);for(yield*this.mergeSort(s,end);;){if(s===start+1){let t=start;for(;t<end-1&&this.data[t]>this.data[t+1];){this.readFromPosition(t),this.readFromPosition(t+1),this.writeToPosition(t)&&(yield),this.writeToPosition(t+1)&&(yield);var r=this.data[t];this.data[t]=this.data[t+1],this.data[t+1]=r,t++}break}var o=start+Math.floor((s-start)/2);yield*this.mergeSort(start,o);let t=start,i=o,e=s;for(;;){if(i===e)break;if(i!==t&&(e===end||this.data[t]<this.data[e])){this.readFromPosition(t),this.readFromPosition(i),this.writeToPosition(t)&&(yield),this.writeToPosition(i)&&(yield);var h=this.data[t];this.data[t]=this.data[i],this.data[i]=h,t++}else{if(!(e<end&&this.data[e]<=this.data[t]))break;this.readFromPosition(e),this.readFromPosition(i),this.writeToPosition(e)&&(yield),this.writeToPosition(i)&&(yield);h=this.data[e];this.data[e]=this.data[i],this.data[i]=h,e++}i++}s=start+(s-o);let a=i-1;for(;a>s&&this.data[a-1]>this.data[a];){this.readFromPosition(a),this.readFromPosition(a-1),this.writeToPosition(a)&&(yield),this.writeToPosition(a-1)&&(yield);var n=this.data[a];this.data[a]=this.data[a-1],this.data[a-1]=n,a--}for(;a<end-1&&this.data[a+1]<this.data[a];){this.readFromPosition(a),this.readFromPosition(a+1),this.writeToPosition(a)&&(yield),this.writeToPosition(a+1)&&(yield);var d=this.data[a];this.data[a]=this.data[a+1],this.data[a+1]=d,a++}if(s===start)break}0===start&&end===this.dataLength&&this.advanceGenerator()}}*quicksort(){this.operationsPerFrame=Math.ceil(this.dataLength*Math.log(this.dataLength)/2250);var a=new Array(this.dataLength),s=(a[0]=0,a[1]=this.dataLength-1,new Array(this.dataLength));let i=1,r=0;for(;0<i;){for(let e=0;e<i;e++){var o=this.data[Math.floor((a[2*e]+a[2*e+1])/2)];this.readFromPosition(Math.floor((a[2*e]+a[2*e+1])/2));let t=a[2*e]-1,i=a[2*e+1]+1;for(;;){for(;t++,this.readFromPosition(t),this.data[t]<o;);for(this.readFromPosition(t);i--,this.readFromPosition(i),this.data[i]>o;);if(this.readFromPosition(i),t>=i)break;var h=this.data[t];this.data[t]=this.data[i],this.data[i]=h,this.writeToPosition(t)&&(yield),this.writeToPosition(i)&&(yield)}i>a[2*e]&&(s[2*r]=a[2*e],s[2*r+1]=i,r++),a[2*e+1]>i+1&&(s[2*r]=i+1,s[2*r+1]=a[2*e+1],r++)}i=r;for(let t=r=0;t<2*i;t++)a[t]=s[t]}this.advanceGenerator()}*shellsort(){this.operationsPerFrame=Math.ceil(this.dataLength/100);var t=[],i=2.2436091;let e=1;for(;;){var a=Math.ceil((Math.pow(i,e)-1)/(i-1));if(a>=this.dataLength)break;t.unshift(a),e++}for(let o=0;o<t.length;o++){var s=t[o];for(let i=s;i<this.dataLength;i++){var r=this.data[i];this.readFromPosition(i);let t=i;for(;t>=s&&this.data[t-s]>r;t-=s)this.data[t]=this.data[t-s],this.writeToPosition(t)&&(yield);this.data[t]=r,this.writeToPosition(t)&&(yield)}}this.advanceGenerator()}*cycleSort(){this.operationsPerFrame=Math.ceil(this.dataLength/2e3);var a=new Array(this.dataLength);for(let t=0;t<this.dataLength;t++)a[t]=!1;for(let o=0;o<this.dataLength;o++)if(!a[o]){this.readFromPosition(o);let i=this.data[o];var s=i;let e=0;do{for(let t=e=0;t<this.dataLength;t++)this.readFromPosition(t),this.data[t]<i&&e++;i>s&&e--;var r=this.data[e];this.data[e]=i,i=r,this.writeToPosition(e)&&(yield),a[e]=!0}while(e!==o)}this.advanceGenerator()}*msdRadixSort(){let t=0;var i=1/Math.log(2);for(let s=0;s<this.dataLength;s++){this.readFromPosition(s);var e=Math.log(this.data[s])*i;t=Math.max(t,e)}t=Math.round(t),this.operationsPerFrame=Math.ceil(this.dataLength*t/650);var r=new Array(this.dataLength),o=(r[0]=0,r[1]=this.dataLength-1,new Array(this.dataLength));let a=1,h=0;var n=new Array(this.dataLength);let d=Math.pow(2,t-1);for(let l=0;l<t;l++){for(let s=0;s<a;s++){let t=r[2*s],i=r[2*s+1];for(let e=r[2*s];e<=r[2*s+1];e++)this.readFromPosition(e),0==Math.floor(this.data[e]/d)%2?(n[t]=this.data[e],this.writeToPosition(t)&&(yield),t++):(n[i]=this.data[e],this.writeToPosition(i)&&(yield),i--);for(let a=r[2*s];a<=r[2*s+1];a++)this.data[a]=n[a],this.writeToPosition(a)&&(yield);t--,i++,t>r[2*s]&&(o[2*h]=r[2*s],o[2*h+1]=t,h++),r[2*s+1]>i&&(o[2*h]=i,o[2*h+1]=r[2*s+1],h++)}a=h;for(let t=h=0;t<2*a;t++)r[t]=o[t];d/=2}this.advanceGenerator()}*lsdRadixSort(){let t=0;var i=1/Math.log(2);for(let a=0;a<this.dataLength;a++){this.readFromPosition(a);var e=Math.log(this.data[a])*i;t=Math.max(t,e)}t=Math.round(t),this.operationsPerFrame=Math.ceil(this.dataLength*t/650);var r=new Array(this.dataLength);let o=1;for(let s=0;s<t;s++){let t=0,i=this.dataLength-1;for(let e=0;e<this.dataLength;e++)this.readFromPosition(e),0==Math.floor(this.data[e]/o)%2?(r[t]=this.data[e],this.writeToPosition(t)&&(yield),t++):(r[i]=this.data[e],this.writeToPosition(i)&&(yield),i--);t--,i++;for(let a=0;a<=t;a++)this.data[a]=r[a],this.writeToPosition(a)&&(yield);for(let s=0;s<this.dataLength-i;s++)this.data[i+s]=r[this.dataLength-1-s],this.writeToPosition(i+s)&&(yield);o*=2}this.advanceGenerator()}*gravitySort(){this.operationsPerFrame=Math.ceil(this.dataLength*this.dataLength/1e6);var e=new Array(this.dataLength);for(let r=0;r<this.dataLength;r++){e[r]=new Array(this.dataLength);for(let t=0;t<this.dataLength;t++)e[r][t]=!1}let a=0,i=0;for(let o=0;o<this.dataLength;o++){this.readFromPosition(o);var s=this.data[o];for(let t=0;t<s;t++)e[o][t]=!0;s-o>i&&(i=s-o,a=o)}for(let h=0;h<this.dataLength;h++){for(let i=this.dataLength-1;0<=i;i--)if(e[i][h]){let t=i;for(;++t<this.dataLength&&!e[t][h];);t--,e[i][h]=!1,e[t][h]=!0,this.data[i]--,this.data[t]++,this.writeToPosition(i,!1,!1),this.writeToPosition(t,!1,!1)}this.writeToPosition(a,!1,!0)&&(yield),this.numWrites--,this.inFrameOperations--}this.advanceGenerator()}}export{SortingAlgorithms};